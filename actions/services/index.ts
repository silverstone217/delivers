"use server";

import { prisma } from "@/lib/prisma";
import { getUser } from "../authAction";
import z from "zod";
import {
  AddCompanySchema,
  UpdateCompanySchema,
  UpdateLogoCompanySchema,
} from "@/schema/companies";
import { NO_IMAGE_URL } from "@/lib/env";
import { PERMIT_ROLES } from "@/utils/service";

// --------------------
// GET Delivery Company
// --------------------
export const getDeliveryCompany = async () => {
  const user = await getUser();

  if (!user) return [];

  const companies = await prisma.deliveryCompany.findMany({
    where: {
      ownerId: user.id,
    },
  });

  return companies ?? [];
};

// --------------------
// TYPES
// --------------------
export type NewServiceType = z.infer<typeof AddCompanySchema>;
export type UpdateLogoType = z.infer<typeof UpdateLogoCompanySchema>;

// --------------------
// ADD NEW SERVICE
// --------------------
export const addNewService = async (data: NewServiceType) => {
  try {
    const user = await getUser();
    if (!user) {
      return {
        error: true,
        message: "Non authentifi√©, veuillez vous connecter pour continuer.",
        companyId: null,
      };
    }

    // check roles &&
    // and can user create many service ?
    const hasAlreadyCreated = await prisma.deliveryCompany.findMany({
      where: { ownerId: user.id },
    });

    if (hasAlreadyCreated.length > 0 && !PERMIT_ROLES.includes(user.role)) {
      return {
        error: true,
        message: "Acces refuse, vous posseder deja un service.",
        companyId: null,
      };
    }

    // ‚úÖ Validation stricte avec zod
    const result = AddCompanySchema.safeParse(data);
    if (!result.success) {
      const errMsg = result.error.issues.map((e) => e.message).join(", ");
      return {
        error: true,
        message:
          errMsg || "Erreur de validation des donn√©es. V√©rifiez vos champs.",
        companyId: null,
      };
    }

    const { name, description } = result.data;
    const logo = NO_IMAGE_URL;

    // ‚úÖ Cr√©ation dans Prisma
    const newService = await prisma.deliveryCompany.create({
      data: {
        name,
        description: description ?? undefined,
        ownerId: user.id,
        logo,
      },
      select: { id: true },
    });

    return {
      error: false,
      message: "Compagnie cr√©√©e avec succ√®s ‚úÖ",
      companyId: newService.id,
    };
  } catch (error) {
    console.error("[addNewService]", error);
    return {
      error: true,
      message: "Oops ! Une erreur est survenue, veuillez r√©essayer.",
      companyId: null,
    };
  }
};

// --------------------
// UPDATE LOGO COMPANY
// --------------------
export const updateLogo = async (data: UpdateLogoType) => {
  try {
    const user = await getUser();
    if (!user) {
      return {
        error: true,
        message: "Non authentifi√©, veuillez vous connecter pour continuer.",
      };
    }

    // ‚úÖ Validation stricte
    const result = UpdateLogoCompanySchema.safeParse(data);
    if (!result.success) {
      const errMsg = result.error.issues.map((e) => e.message).join(", ");
      return {
        error: true,
        message:
          errMsg || "Erreur de validation des donn√©es. V√©rifiez vos champs.",
      };
    }

    const { id, logo } = result.data;

    // ‚úÖ V√©rifie que la compagnie appartient bien √† l'utilisateur
    const company = await prisma.deliveryCompany.findFirst({
      where: { id, ownerId: user.id },
      select: { id: true },
    });

    if (!company) {
      return {
        error: true,
        message: "Ce service ne vous appartient pas ou a √©t√© supprim√©.",
      };
    }

    // ‚úÖ Mise √† jour du logo
    await prisma.deliveryCompany.update({
      where: { id: company.id },
      data: { logo },
    });

    return {
      error: false,
      message: "Logo mis √† jour avec succ√®s üéâ",
    };
  } catch (error) {
    console.error("[updateLogo]", error);
    return {
      error: true,
      message: "Oops ! Une erreur est survenue, veuillez r√©essayer.",
    };
  }
};

// --------------------
// UPDATE  COMPANY
// --------------------
export type UpdateServiceType = z.infer<typeof UpdateCompanySchema>;
export const updateService = async (data: UpdateServiceType) => {
  try {
    const user = await getUser();
    if (!user) {
      return {
        error: true,
        message: "Non authentifi√©, veuillez vous connecter pour continuer.",
      };
    }

    // ‚úÖ Validation stricte avec zod
    const result = UpdateCompanySchema.safeParse(data);
    if (!result.success) {
      const errMsg = result.error.issues.map((e) => e.message).join(", ");
      return {
        error: true,
        message:
          errMsg || "Erreur de validation des donn√©es. V√©rifiez vos champs.",
        companyId: null,
      };
    }

    const { name, description, id } = result.data;

    const isCompanyExist = await prisma.deliveryCompany.findFirst({
      where: { id, ownerId: user.id },
    });

    if (!isCompanyExist) {
      return {
        error: true,
        message: "Ce service n'est plus disponible",
      };
    }

    await prisma.deliveryCompany.update({
      where: { id: isCompanyExist.id },
      data: {
        name,
        description: description ? description : undefined,
      },
    });

    return {
      error: false,
      message: "Modifi√© avec success",
    };
  } catch (error) {
    console.log(error);
    return {
      error: true,
      message: "Oops ! Une erreur est survenue, veuillez r√©essayer.",
    };
  }
};

//
//
//
